library(bruceR)
library(openxlsx)
library(ggridges)
library(ggsci)
library(svglite)
rm(list=ls())
gc()
set.wd()
source('../Supp_0_Subfunctions/s_OOSD_ResStats.R')
source('../Supp_0_Subfunctions/s_SubG_ResStats.R')
sink('../Res_1_Logs/Log_RepVis_10_SubG_Suicide_Results.txt',
     append = F,
     type = 'output',
     split = T)
# Generate Coef Comparison Summary Table ----------------------------------

MdlMethod = 'UpSampMdl'
Subgroup = c('Boy','Girl')
Input_Dir = '../Res_2_Results/ResML_Subgroup_Suicide/'
Res_Sex <- Get.Suicide.SubG.Summary.Table(MdlMethod,Subgroup,Input_Dir)

Subgroup = c('PrimarySchool','JuniorSchool','SeniorSchool')
Res_Phase <- Get.Suicide.SubG.Summary.Table(MdlMethod,Subgroup,Input_Dir)

Subgroup = c('Eastern','Northeast','Central','Western')
Res_Area <- Get.Suicide.SubG.Summary.Table(MdlMethod,Subgroup,Input_Dir)

rename(Res_Sex$Compact,
       'Effect Size (Sex)' = 'Difference',
       'p-value (Sex)' = 'pval') -> T_sex
rename(Res_Phase$Compact,
       'Effect Size (Phase of studying)' = 'η²p [90% CI of η²p]',
       'p-value (Phase of studying)' = 'pval') -> T_Phase
rename(Res_Area$Compact,
       'Effect Size (Geographic Area)' = 'η²p [90% CI of η²p]',
       'p-value (Geographic Area)' = 'pval') -> T_Area

All_T <- merge(T_sex,T_Phase,by = 'Index')
All_T <- merge(All_T,T_Area,by = 'Index')
All_T %>% 
  arrange(factor(Index,levels=c('ACC','Sensitivity','Specificity',
                                'Balanced ACC','F1-score','PPV','NPV',
                                'Anxiety','Perceived Stress','Academic Burn-out',
                                'Internet Addiction','Non-suicidal Self-injury',
                                'Be Bullied','Education Level (Grade)'))) -> All_T
All_T$`p-value (Sex)`[All_T$`p-value (Sex)`<0.001] <- '<0.001'
All_T$`p-value (Phase of studying)`[All_T$`p-value (Phase of studying)`<0.001] <- '<0.001'
All_T$`p-value (Geographic Area)`[All_T$`p-value (Geographic Area)`<0.001] <- '<0.001'

write.xlsx(All_T,
           file = '../Res_2_Results/Res_SummaryT_Subgroup_Suicide.xlsx')

All_T %>%
  select(-c(`Effect Size (Sex)`,`p-value (Sex)`,
            `Effect Size (Phase of studying)`,`p-value (Phase of studying)`,
            `Effect Size (Geographic Area)`,`p-value (Geographic Area)`)) %>%
  print_table(file = '../Res_2_Results/Res_SummaryT_Subgroup_Suicide.doc',
              row.names = F)

# Plot Coefs and Balanced ACC: Sex-Subgroup -------------------------------
MdlMethod = 'UpSampMdl'
Subgroup = c('Boy','Girl')
Input_Dir = '../Res_2_Results/ResML_Subgroup_Suicide/'
data <- Extract.Res.Coef(MdlMethod,Subgroup,Input_Dir)
data_coef <- pivot_longer(data,cols = c(Anxiety,`Perceived Stress`,`Academic Burn-out`,
                           `Internet Addiction`,`Non-suicidal Self-injury`,
                           `Education Level (Grade)`),
             values_to = 'Feature Importance',
             names_to = 'Predictors') %>%
  select(`Feature Importance`,Predictors,Group)
data_coef$Predictors <- factor(data_coef$Predictors,
                               levels=c('Anxiety','Non-suicidal Self-injury',
                                        'Perceived Stress','Internet Addiction',
                                        'Academic Burn-out','Education Level (Grade)'),
                               labels = c('Anxiety','Non-suicidal Self-injury',
                                          'Perceived Stress','Internet Addiction',
                                          'Academic Burn-out','Age'))
p <- data_coef %>%
  ggplot(aes(x=Predictors,y=`Feature Importance`,fill=Group))+
  geom_violin(width=0.4,alpha=0.5,trim = T,scale = 'width')+
  # geom_boxplot(outlier.shape = NA,width = 0.1,alpha=0.1,
  #              position = position_dodge(width = 0.4))+
  ggpubr::stat_anova_test(aes(group = Group),
                          label = 'p.adj.signif',
                          label.y = 9,
                          method = 'one_way',
                          p.adjust.method = 'bonferroni',
                          significance = list(cutpoints = c(0, 0.001, 0.01, 0.05, Inf),
                                              symbols = c("***", "**", "*", "ns")))+
  theme_bruce()+theme(axis.text.x = element_text(angle = 15,hjust = 1),
                      axis.title.x = element_blank(),
                      panel.grid.major.y = element_line(colour = 'gray80',
                                                        linewidth = 0.2,
                                                        linetype = 'dashed'),
                      legend.position = 'top',
                      legend.title = element_blank())+
  ylim(-1.3,9)+
  ggsci::scale_fill_npg()
p
ggsave('../Res_2_Results/Res_SexSubgroup_Coef_Suicide.png',
       width = 8,
       height = 6,
       plot = p)
ggsave('../Res_2_Results/Res_SexSubgroup_Coef_Suicide.svg',
       width = 8,
       height = 6,
       plot = p)

p <- data %>%
  ggplot(aes(x=`Balanced ACC`*100,y=Group,fill=Group))+
  geom_density_ridges_gradient(scale = 0.8,
                               rel_min_height = 0.001,
                               panel_scaling = T)+
  theme_ridges()+ggsci::scale_fill_npg(alpha=0.5)+
  theme(legend.position = 'none',
        axis.title.y = element_blank(),
        axis.title.x = element_text(hjust = 0.5))+
  xlab('Balanced ACC (%)')+
  geom_vline(aes(xintercept=mean(`Balanced ACC`[Group=='Boy'])*100),
             colour=ggpubr::get_palette("npg",2)[1],
             linetype='dashed',
             linewidth=1.5,
             alpha=0.5)+
  geom_vline(aes(xintercept=mean(`Balanced ACC`[Group=='Girl'])*100),
             colour=ggpubr::get_palette("npg",2)[2],
             linetype='dashed',
             linewidth=1.5,
             alpha=0.5)+
  annotate('text',
           x=mean(data$`Balanced ACC`[data$Group=='Boy'])*100+0.01,
           y=1.6,
           colour = ggpubr::get_palette("npg",2)[1],
           size=5,
           hjust=0,
           label=sprintf("Boy=%.2f%%",
                         mean(data$`Balanced ACC`[data$Group=='Boy'])*100))+
  annotate('text',
           x=mean(data$`Balanced ACC`[data$Group=='Girl'])*100-0.01,
           y=1.9,
           colour = ggpubr::get_palette("npg",2)[2],
           size=5,
           hjust=1,
           label=sprintf("Girl=%.2f%%",
                         mean(data$`Balanced ACC`[data$Group=='Girl'])*100))
# p
ggsave('../Res_2_Results/Res_SexSubgroup_BalaACC_Suicide.png',
       bg = 'white',
       width = 6,
       height = 6,
       plot = p)
ggsave('../Res_2_Results/Res_SexSubgroup_BalaACC_Suicide.svg',
       width = 6,
       height = 6,
       plot = p)

# Plot Coefs and Balanced ACC: Phase of studying-Subgroup -----------------
MdlMethod = 'UpSampMdl'
Subgroup = c('PrimarySchool','JuniorSchool','SeniorSchool')
Input_Dir = '../Res_2_Results/ResML_Subgroup_Suicide/'
data <- Extract.Res.Coef(MdlMethod,Subgroup,Input_Dir)
data$Group <- factor(data$Group,
                     levels = c('PrimarySchool','JuniorSchool','SeniorSchool'),
                     labels = c('Primary School','Middle School','High School'))
pivot_longer(data,cols = c(Anxiety,`Perceived Stress`,`Academic Burn-out`,
                           `Internet Addiction`,`Non-suicidal Self-injury`,
                           `Education Level (Grade)`),
             values_to = 'Feature Importance',
             names_to = 'Predictors') %>%
  select(`Feature Importance`,Predictors,Group) -> data_coef
data_coef$Predictors <- factor(data_coef$Predictors,
                               levels=c('Anxiety','Non-suicidal Self-injury',
                                        'Perceived Stress','Internet Addiction',
                                        'Academic Burn-out','Education Level (Grade)'),
                               labels = c('Anxiety','Non-suicidal Self-injury',
                                          'Perceived Stress','Internet Addiction',
                                          'Academic Burn-out','Age'))
data_coef %>%
  ggplot(aes(x=Predictors,y=`Feature Importance`,fill=Group))+
  geom_violin(width=0.6,alpha=0.5,trim = T,scale = 'width')+
  # geom_boxplot(outlier.shape = NA,width = 0.1,alpha=0.1,
  #              position = position_dodge(width = 0.6))+
  ggpubr::stat_anova_test(aes(group = Group),
                          label = 'p.adj.signif',
                          label.y = 10.1,
                          method = 'one_way',
                          p.adjust.method = 'bonferroni',
                          significance = list(cutpoints = c(0, 0.001, 0.01, 0.05, Inf),
                                              symbols = c("***", "**", "*", "ns")))+
  theme_bruce()+theme(axis.text.x = element_text(angle = 15,hjust = 1),
                      axis.title.x = element_blank(),
                      panel.grid.major.y = element_line(colour = 'gray80',
                                                        linewidth = 0.2,
                                                        linetype = 'dashed'),
                      legend.position = 'top',
                      legend.title = element_blank())+
  scale_fill_manual(values=ggpubr::get_palette("npg",5)[-1:-2]) -> p
# p
ggsave('../Res_2_Results/Res_PhaseSubgroup_Coef_Suicide.png',
       width = 8,
       height = 6,
       plot = p)
ggsave('../Res_2_Results/Res_PhaseSubgroup_Coef_Suicide.svg',
       width = 8,
       height = 6,
       plot = p)
# data$Group <- forcats::fct_rev(data$Group)
p <- data %>%
  ggplot(aes(x=`Balanced ACC`*100,y=Group,fill=Group))+
  geom_density_ridges_gradient(scale = 0.8,
                               rel_min_height = 0.001,
                               panel_scaling = T)+
  theme_ridges()+ scale_fill_manual(values=alpha(ggpubr::get_palette("npg",5)[-1:-2],0.5))+
  theme(legend.position = 'none',
        axis.title.y = element_blank(),
        axis.title.x = element_text(hjust = 0.5),
        axis.text.y = element_text(angle=90,hjust=0.5,size = 7))+
  xlab('Balanced ACC (%)')+
  geom_vline(aes(xintercept=mean(`Balanced ACC`[Group=='Primary School'])*100),
             colour=ggpubr::get_palette("npg",5)[3],
             linetype='dashed',
             linewidth=1.5,
             alpha=0.5)+
  geom_vline(aes(xintercept=mean(`Balanced ACC`[Group=='Middle School'])*100),
             colour=ggpubr::get_palette("npg",5)[4],
             linetype='dashed',
             linewidth=1.5,
             alpha=0.5)+
  geom_vline(aes(xintercept=mean(`Balanced ACC`[Group=='High School'])*100),
             colour=ggpubr::get_palette("npg",5)[5],
             linetype='dashed',
             linewidth=1.5,
             alpha=0.5)+
  annotate('text',
           x=mean(data$`Balanced ACC`[data$Group=='Primary School'])*100+0.01,
           y=1.7,
           colour = ggpubr::get_palette("npg",5)[3],
           size=4,
           hjust=0,
           label=sprintf("Primary School=%.2f%%\n(Age: 9~12 years old)",
                         mean(data$`Balanced ACC`[data$Group=='Primary School'])*100))+
  annotate('text',
           x=mean(data$`Balanced ACC`[data$Group=='Middle School'])*100-0.01,
           y=1.8,
           colour = ggpubr::get_palette("npg",5)[4],
           size=4,
           hjust=1,
           label=sprintf("Middle School=%.2f%%\n(Age: 12~15 years old)",
                         mean(data$`Balanced ACC`[data$Group=='Middle School'])*100))+
  annotate('text',
           x=mean(data$`Balanced ACC`[data$Group=='High School'])*100+0.01,
           y=2.8,
           colour = ggpubr::get_palette("npg",5)[5],
           size=4,
           hjust=0,
           label=sprintf("High School=%.2f%%\n(Age: 15~18 years old)",
                         mean(data$`Balanced ACC`[data$Group=='High School'])*100))

p
ggsave('../Res_2_Results/Res_PhaseSubgroup_BalaACC_Suicide.png',
       bg = 'white',
       width = 6,
       height = 6,
       plot = p)
ggsave('../Res_2_Results/Res_PhaseSubgroup_BalaACC_Suicide.svg',
       width = 6,
       height = 6,
       plot = p)

# Plot Coefs and Balanced ACC: Geographic Area-Subgroup -------------------
MdlMethod = 'UpSampMdl'
Subgroup = c('Eastern','Northeast','Central','Western')
Input_Dir = '../Res_2_Results/ResML_Subgroup_Suicide/'
data <- Extract.Res.Coef(MdlMethod,Subgroup,Input_Dir)
data$Group <- factor(data$Group,
                     levels =  c('Eastern','Northeast','Central','Western'))
pivot_longer(data,cols = c(Anxiety,`Perceived Stress`,`Academic Burn-out`,
                           `Internet Addiction`,`Non-suicidal Self-injury`,
                           `Education Level (Grade)`),
             values_to = 'Feature Importance',
             names_to = 'Predictors') %>%
  select(`Feature Importance`,Predictors,Group) -> data_coef
data_coef$Predictors <- factor(data_coef$Predictors,
                               levels=c('Anxiety','Non-suicidal Self-injury',
                                        'Perceived Stress','Internet Addiction',
                                        'Academic Burn-out','Education Level (Grade)'),
                               labels = c('Anxiety','Non-suicidal Self-injury',
                                          'Perceived Stress','Internet Addiction',
                                          'Academic Burn-out','Age'))
data_coef %>%
  ggplot(aes(x=Predictors,y=`Feature Importance`,fill=Group))+
  geom_violin(width=0.6,alpha=0.5,trim = T,scale = 'width')+
  # geom_boxplot(outlier.shape = NA,width = 0.1,alpha=0.1,
  #              position = position_dodge(width = 0.6))+
  ggpubr::stat_anova_test(aes(group = Group),
                          label = 'p.adj.signif',
                          label.y = 8.7,
                          method = 'one_way',
                          p.adjust.method = 'bonferroni',
                          significance = list(cutpoints = c(0, 0.001, 0.01, 0.05, Inf),
                                              symbols = c("***", "**", "*", "ns")))+
  theme_bruce()+theme(axis.text.x = element_text(angle = 15,hjust = 1),
                      axis.title.x = element_blank(),
                      panel.grid.major.y = element_line(colour = 'gray80',
                                                        linewidth = 0.2,
                                                        linetype = 'dashed'),
                      legend.position = 'top',
                      legend.title = element_blank())+
  scale_fill_manual(values=ggpubr::get_palette("npg",9)[-1:-5]) -> p
# p
ggsave('../Res_2_Results/Res_GeoAreaSubgroup_Coef_Suicide.png',
       width = 8,
       height = 6,
       plot = p)
ggsave('../Res_2_Results/Res_GeoAreaSubgroup_Coef_Suicide.svg',
       width = 8,
       height = 6,
       plot = p)
# data$Group <- forcats::fct_rev(data$Group)
p <- data %>%
  ggplot(aes(x=`Balanced ACC`*100,y=Group,fill=Group))+
  geom_density_ridges_gradient(scale = 0.8,
                               rel_min_height = 0.001,
                               panel_scaling = T)+
  theme_ridges()+ scale_fill_manual(values=alpha(ggpubr::get_palette("npg",9)[-1:-5],0.5))+
  theme(legend.position = 'none',
        axis.title.y = element_blank(),
        axis.title.x = element_text(hjust = 0.5),
        axis.text.y = element_text(angle=90,hjust=0.5,size = 7))+
  xlab('Balanced ACC (%)')+
  geom_vline(aes(xintercept=mean(`Balanced ACC`[Group=='Eastern'])*100),
             colour=ggpubr::get_palette("npg",9)[6],
             linetype='dashed',
             linewidth=1.5,
             alpha=0.5)+
  geom_vline(aes(xintercept=mean(`Balanced ACC`[Group=='Northeast'])*100),
             colour=ggpubr::get_palette("npg",9)[7],
             linetype='dashed',
             linewidth=1.5,
             alpha=0.5)+
  geom_vline(aes(xintercept=mean(`Balanced ACC`[Group=='Central'])*100),
             colour=ggpubr::get_palette("npg",9)[8],
             linetype='dashed',
             linewidth=1.5,
             alpha=0.5)+
  geom_vline(aes(xintercept=mean(`Balanced ACC`[Group=='Western'])*100),
             colour=ggpubr::get_palette("npg",9)[9],
             linetype='dashed',
             linewidth=1.5,
             alpha=0.5)+
  annotate('text',
           x=mean(data$`Balanced ACC`[data$Group=='Eastern'])*100+0.01,
           y=3.9,
           colour = ggpubr::get_palette("npg",9)[6],
           size=4,
           hjust=0,
           label=sprintf("Eastern China=%.2f%%",
                         mean(data$`Balanced ACC`[data$Group=='Eastern'])*100))+
  annotate('text',
           x=mean(data$`Balanced ACC`[data$Group=='Northeast'])*100,
           y=3.5,
           colour = ggpubr::get_palette("npg",9)[7],
           size=4,
           hjust=0.5,
           label=sprintf("Northeast China=%.2f%%",
                         mean(data$`Balanced ACC`[data$Group=='Northeast'])*100))+
  annotate('text',
           x=mean(data$`Balanced ACC`[data$Group=='Central'])*100+0.01,
           y=2.75,
           colour = ggpubr::get_palette("npg",9)[8],
           size=4,
           hjust=0,
           label=sprintf("Central China=%.2f%%",
                         mean(data$`Balanced ACC`[data$Group=='Central'])*100))+
  annotate('text',
           x=mean(data$`Balanced ACC`[data$Group=='Western'])*100,
           y=1.85,
           colour = ggpubr::get_palette("npg",9)[9],
           size=4,
           hjust=1,
           label=sprintf("Western China=%.2f%%",
                         mean(data$`Balanced ACC`[data$Group=='Western'])*100))

# p
ggsave('../Res_2_Results/Res_GeoAreaSubgroup_BalaACC_Suicide.png',
       bg = 'white',
       width = 6,
       height = 6,
       plot = p)
ggsave('../Res_2_Results/Res_GeoAreaSubgroup_BalaACC_Suicide.svg',
       width = 6,
       height = 6,
       plot = p)